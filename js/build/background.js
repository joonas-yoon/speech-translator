'use strict';const API_URL="http://localhost/api";function getRandomHash(){return Math.random().toString(36).substring(2,12)}function getCurrentClipname(){return getRandomHash()+"-"+new Date().getTime()}function getOptions(callback){chrome.storage.local.get("options",function(item){callback(item.options||{})})}function errorMessage(tabId,itemId,msg){chrome.tabs.sendMessage(tabId,{method:"message",itemId:itemId,text:"<i>["+msg+"]</i>"})}class Translator{constructor(tab,stream){const self=this;this.tab=tab,this.stream=stream,this.visualTimerId=this.visualize(),this.chunks=[],this.mediaRecorder=new MediaRecorder(stream),this.mediaRecorder.ondataavailable=function(e){self.chunks.push(e.data)};const audioElement=document.createElement("audio");audioElement.setAttribute("preload","auto"),audioElement.autobuffer=!0,audioElement.srcObject=this.stream,audioElement.load(),audioElement.play(),this.audio=audioElement,this.appRunning=!1}get active(){return this.stream&&this.stream.active}get state(){return this.active&&this.mediaRecorder&&this.mediaRecorder.state}uncapture(){clearInterval(this.visualTimerId),this.stream.getTracks().forEach(function(track){track.stop()})}visualize(){const audioCtx=new(window.AudioContext||window.webkitAudioContext),source=audioCtx.createMediaStreamSource(this.stream),analyser=audioCtx.createAnalyser();analyser.fftSize=2048;const bufferLength=analyser.frequencyBinCount,dataArray=new Float32Array(bufferLength);return source.connect(analyser),setInterval(function(self){analyser.getFloatTimeDomainData(dataArray);const sum=dataArray.reduce((a,b)=>Math.abs(a)+Math.abs(b),0),avg=sum/dataArray.length||0,percentage=Math.max(0,Math.min(1,Math.abs(10*avg)));chrome.tabs.sendMessage(self.tab.id,{method:"visualize",avgDecibel:percentage})}.bind(null,this),200)}startRecord(){const self=this,prevState=this.state;this.mediaRecorder.start(),setTimeout(function(){self.appRunning&&self.stopRecord()},1e3*10)}stopRecord(){this.state;this.mediaRecorder.stop(),this.play(),this.appRunning&&this.startRecord()}play(){const audio=document.createElement("audio"),blob=new Blob(this.chunks,{type:"audio/ogg; codecs=opus"});this.chunks.length&&(this.chunks=[],audio.src=window.URL.createObjectURL(blob),this.requestRecognize(blob))}start(){this.appRunning=!0,this.startRecord()}stop(){this.appRunning=!1,this.stopRecord()}requestRecognize(audio){const self=this,fileData=new FormData,clipId=getCurrentClipname();fileData.append("audio",audio),fileData.append("filename",clipId),$.ajax({url:API_URL+"/app/collect",type:"post",data:fileData,processData:!1,contentType:!1}).done(function(response){response&&response.results.length&&chrome.tabs.sendMessage(self.tab.id,{method:"recognize",results:response.results||[]},async function(resp){for(const res of resp)await self.requestTranslate(res)})}).fail(function(xhr){errorMessage(self.tab.id,clipId,`${xhr.statusText} - ${xhr.status}`)})}async requestTranslate(response){if(!response||0===Object.keys(response).length)return;const self=this,itemId=response.itemId,text=response.text;await getOptions(function(options){$.ajax({url:API_URL+"/app/translate",type:"post",data:JSON.stringify({src_lang:options.srcLangCode||"en",dst_lang:options.dstLangCode||"ko",src_text:text}),processData:!1,contentType:"application/json"}).done(function(translatedResult){let translatedText="";translatedResult&&(translatedText=translatedResult[0]),chrome.tabs.sendMessage(self.tab.id,{method:"message",itemId:itemId,text:translatedText})}).fail(function(xhr){errorMessage(self.tab.id,response.itemId,`${xhr.statusText} - ${xhr.status}`)})})}}const clients={};chrome.browserAction.onClicked.addListener(function(tab){clients[tab.id]&&clients[tab.id].active?(clients[tab.id].uncapture(),delete clients[tab.id],chrome.tabs.sendMessage(tab.id,{method:"hideViewer"})):chrome.tabCapture.capture({video:!1,audio:!0},function(stream){return stream?void(clients[tab.id]=new Translator(tab,stream),chrome.tabs.sendMessage(tab.id,{method:"showViewer"})):void console.error("Error starting tab capture: "+(chrome.runtime.lastError.message||"UNKNOWN"))})}),chrome.runtime.onMessage.addListener(function(data,sender,sendResponse){clients[sender.tab.id]&&("start"===data.msg?(clients[sender.tab.id].start(),sendResponse(!0)):"stop"===data.msg?(clients[sender.tab.id].stop(),sendResponse(!0)):"display"===data.msg&&sendResponse(clients[sender.tab.id]!==void 0))});