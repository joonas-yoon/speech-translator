'use strict';const API_URL="http://localhost/api";function getRandomHash(){return Math.random().toString(36).substring(2,12)}function getCurrentClipname(){return getRandomHash()+"-"+new Date().getTime()}function getOptions(a){chrome.storage.local.get("options",function(b){a(b.options||{})})}function errorMessage(a,b,c){chrome.tabs.sendMessage(a,{method:"message",itemId:b,text:"<i>["+c+"]</i>"})}class Translator{constructor(a,b){const c=this;this.tab=a,this.stream=b,this.visualTimerId=this.visualize(),this.chunks=[],this.mediaRecorder=new MediaRecorder(b),this.mediaRecorder.ondataavailable=function(a){c.chunks.push(a.data)};const d=document.createElement("audio");d.setAttribute("preload","auto"),d.autobuffer=!0,d.srcObject=this.stream,d.load(),d.play(),this.audio=d,this.appRunning=!1}get active(){return this.stream&&this.stream.active}get state(){return this.active&&this.mediaRecorder&&this.mediaRecorder.state}uncapture(){clearInterval(this.visualTimerId),this.stream.getTracks().forEach(function(a){a.stop()})}visualize(){const a=new(window.AudioContext||window.webkitAudioContext),b=a.createMediaStreamSource(this.stream),c=a.createAnalyser();c.fftSize=2048;const d=c.frequencyBinCount,e=new Float32Array(d);return b.connect(c),setInterval(function(a){var b=Math.max,d=Math.min,f=Math.abs;c.getFloatTimeDomainData(e);const g=e.reduce((c,a)=>f(c)+f(a),0),h=g/e.length||0,i=b(0,d(1,f(10*h)));chrome.tabs.sendMessage(a.tab.id,{method:"visualize",avgDecibel:i})}.bind(null,this),200)}startRecord(){const a=this,b=this.state;this.mediaRecorder.start(),setTimeout(function(){a.appRunning&&a.stopRecord()},10000)}stopRecord(){this.state;this.mediaRecorder.stop(),this.play(),this.appRunning&&this.startRecord()}play(){const a=document.createElement("audio"),b=new Blob(this.chunks,{type:"audio/ogg; codecs=opus"});this.chunks.length&&(this.chunks=[],a.src=window.URL.createObjectURL(b),this.requestRecognize(b))}start(){this.appRunning=!0,this.startRecord()}stop(){this.appRunning=!1,this.stopRecord()}requestRecognize(a){const b=this,c=new FormData,d=getCurrentClipname();c.append("audio",a),c.append("filename",d),$.ajax({url:"http://localhost/api/app/collect",type:"post",data:c,processData:!1,contentType:!1}).done(function(a){a&&a.results.length&&chrome.tabs.sendMessage(b.tab.id,{method:"recognize",results:a.results||[]},async function(a){for(const c of a)await b.requestTranslate(c)})}).fail(function(a){errorMessage(b.tab.id,d,`${a.statusText} - ${a.status}`)})}async requestTranslate(a){if(!a||0===Object.keys(a).length)return;const b=this,c=a.itemId,d=a.text;await getOptions(function(e){$.ajax({url:"http://localhost/api/app/translate",type:"post",data:JSON.stringify({src_lang:e.srcLangCode||"en",dst_lang:e.dstLangCode||"ko",src_text:d}),processData:!1,contentType:"application/json"}).done(function(a){let d="";a&&(d=a[0]),chrome.tabs.sendMessage(b.tab.id,{method:"message",itemId:c,text:d})}).fail(function(c){errorMessage(b.tab.id,a.itemId,`${c.statusText} - ${c.status}`)})})}}const clients={};// Respond to the click on extension Icon
chrome.browserAction.onClicked.addListener(function(a){clients[a.id]&&clients[a.id].active?(clients[a.id].uncapture(),delete clients[a.id],chrome.tabs.sendMessage(a.id,{method:"hideViewer"})):chrome.tabCapture.capture({video:!1,audio:!0},function(b){return b?void(clients[a.id]=new Translator(a,b),chrome.tabs.sendMessage(a.id,{method:"showViewer"})):void console.error("Error starting tab capture: "+(chrome.runtime.lastError.message||"UNKNOWN"))})}),chrome.runtime.onMessage.addListener(function(a,b,c){clients[b.tab.id]&&("start"===a.msg?(clients[b.tab.id].start(),c(!0)):"stop"===a.msg?(clients[b.tab.id].stop(),c(!0)):"display"===a.msg&&c(clients[b.tab.id]!==void 0))});